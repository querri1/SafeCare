<!--æ•°æ®ä¸­å¿ƒé¡µé¢-->
<navigation-bar title="" back="{{false}}" color="black" background="#FFF"></navigation-bar>

<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    <!-- æœªç™»å½•æç¤º -->
    <view class="login-prompt" wx:if="{{!hasLogin}}">
      <view class="prompt-icon">ğŸ”’</view>
      <text class="prompt-title">è¯·å…ˆç™»å½•</text>
      <text class="prompt-desc">ç™»å½•åå³å¯æŸ¥çœ‹æ‚¨çš„æ•°æ®ç»Ÿè®¡</text>
      <button class="btn-login" bindtap="goToLogin">å‰å¾€ç™»å½•</button>
    </view>

    <!-- å·²ç™»å½•å†…å®¹ -->
    <block wx:if="{{hasLogin}}">
    <!-- æ•°æ®æ¦‚è§ˆ -->
    <view class="data-overview">
      <view class="data-card">
        <view class="data-icon">
          <image class="icon-img" src="../../images/icon-fire.png"></image>
        </view>
        <view class="data-content">
          <text class="data-title">è¿ç»­æ‰“å¡</text>
          <text class="data-number">{{consecutiveDays}}</text>
          <text class="data-unit">å¤©</text>
        </view>
      </view>

      <view class="data-card">
        <view class="data-icon">
          <text class="icon">ğŸ“ˆ</text>
        </view>
        <view class="data-content">
          <text class="data-title">æœ¬å‘¨å®Œæˆ</text>
          <text class="data-number">{{weekCompleted}}</text>
          <text class="data-unit">æ¬¡</text>
        </view>
      </view>

      <view class="data-card">
        <view class="data-icon">
          <image class="icon-img" src="../../images/icon-medal.png"></image>
        </view>
        <view class="data-content">
          <text class="data-title">æœ¬æœˆæˆå°±</text>
          <text class="data-number">{{monthAchievements}}</text>
          <text class="data-unit">ä¸ª</text>
        </view>
      </view>
    </view>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <view class="chart-section">
      <view class="chart-header">
        <text class="chart-title">{{currentPeriod === 'week' ? 'æœ€è¿‘7å¤©æ‰“å¡è®°å½•' : currentMonth}}</text>
        <view class="chart-controls">
          <button class="chart-btn {{currentPeriod === 'week' ? 'active' : ''}}" bindtap="switchChartPeriod" data-period="week">å‘¨</button>
          <button class="chart-btn {{currentPeriod === 'month' ? 'active' : ''}}" bindtap="switchChartPeriod" data-period="month">æœˆ</button>
        </view>
      </view>
      
      <!-- å‘¨è§†å›¾ -->
      <view class="chart-container" wx:if="{{currentPeriod === 'week'}}">
        <view class="chart-bars">
          <view class="bar-group {{item.hasCheckin ? 'bar-group-checked' : ''}}" wx:for="{{weekData}}" wx:key="index">
            <view class="bar-wrapper">
              <view class="bar {{item.hasCheckin ? 'bar-checked' : ''}}" style="height: {{item.height}}rpx"></view>
              <view class="emotion-emoji" wx:if="{{item.emotion}}">{{item.emotionEmoji}}</view>
              <view class="check-icon" wx:if="{{item.hasCheckin && !item.emotion}}">âœ“</view>
            </view>
            <text class="bar-label {{item.hasCheckin ? 'label-checked' : ''}}">{{item.label}}</text>
          </view>
        </view>
      </view>

      <!-- æœˆè§†å›¾ -->
      <view class="month-container" wx:if="{{currentPeriod === 'month'}}">
        <view class="month-grid">
          <view 
            class="month-day {{item.hasCheckin ? 'day-checked' : ''}}" 
            wx:for="{{monthData}}" 
            wx:key="day"
            bindtap="onMonthDayTap"
            data-day="{{item.day}}"
            data-has-checkin="{{item.hasCheckin}}"
            data-date="{{item.date}}"
          >
            <text class="day-number">{{item.day}}</text>
            <view class="day-dot" wx:if="{{item.hasCheckin}}"></view>
          </view>
        </view>
      </view>
    </view>

    <!-- è¯„åˆ†è¶‹åŠ¿æŸ±çŠ¶å›¾åŒºåŸŸ -->
    <view class="score-chart-section">
      <view class="score-chart-header">
        <text class="score-chart-title">è¯„åˆ†è¶‹åŠ¿</text>
      </view>
      
      <!-- æ¯æ—¥æ ¸å¿ƒè¿½è¸ª -->
      <view class="score-chart-item">
        <view class="score-chart-subtitle">æ¯æ—¥æ ¸å¿ƒè¿½è¸ª</view>
        <view class="chart-container">
          <view class="chart-bars">
            <view class="bar-group" wx:for="{{scoreWeekData}}" wx:key="index">
              <view class="bar-wrapper">
                <view class="bar bar-score {{item.coreTotal > 0 ? 'bar-score-checked' : ''}}" style="height: {{item.coreHeight}}rpx"></view>
                <view class="score-value" wx:if="{{item.coreTotal > 0}}">{{item.coreTotal}}</view>
              </view>
              <text class="bar-label {{item.coreTotal > 0 ? 'label-checked' : ''}}">{{item.label}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- è‡ªæˆ‘æ·±åº¦æ¢ç´¢ -->
      <view class="score-chart-item">
        <view class="score-chart-subtitle">è‡ªæˆ‘æ·±åº¦æ¢ç´¢</view>
        <view class="chart-container">
          <view class="chart-bars">
            <view class="bar-group" wx:for="{{scoreWeekData}}" wx:key="index">
              <view class="bar-wrapper">
                <view class="bar bar-score {{item.deepTotal > 0 ? 'bar-score-checked' : ''}}" style="height: {{item.deepHeight}}rpx"></view>
                <view class="score-value" wx:if="{{item.deepTotal > 0}}">{{item.deepTotal}}</view>
              </view>
              <text class="bar-label {{item.deepTotal > 0 ? 'label-checked' : ''}}">{{item.label}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å›ºå®šæç¤ºæ–‡æ¡ˆ -->
    <view class="score-tip-section">
      <view class="tip-card">
        <view class="tip-icon">ğŸ’¡</view>
        <view class="tip-content">
          <text class="tip-text">è¿™äº›è¯„åˆ†æ˜¯æ‚¨è‡ªæˆ‘è§‰å¯Ÿçš„å®è´µå·¥å…·ï¼Œä½†ä¸èƒ½æ›¿ä»£åŒ»ç”Ÿçš„ä¸“ä¸šè¯Šæ–­å“¦ã€‚å®šæœŸå¤æŸ¥å¹¶ä¸æ‚¨çš„ä¸»æ²»åŒ»ç”Ÿæ²Ÿé€šè‡³å…³é‡è¦ã€‚</text>
        </view>
      </view>
    </view>

    <!-- æµ‹è¯•è®°å½• -->
    <view class="test-records">
      <view class="section-title">
        <text class="title">æµ‹è¯•è®°å½•</text>
        <button class="btn-text" bindtap="viewAllRecords">æŸ¥çœ‹å…¨éƒ¨</button>
      </view>

      <view class="record-item" wx:for="{{testRecords}}" wx:key="_id" bindtap="viewRecordDetail" data-record="{{item}}">
        <view class="record-icon">
          <image class="icon-img" src="../../images/{{item.type === 'PHQ-9' ? 'icon-brain.png' : 'icon-heart.png'}}"></image>
        </view>
        <view class="record-content">
          <text class="record-title">{{item.type}}</text>
          <text class="record-desc">{{item.severity}}</text>
          <text class="record-date">{{item.date}}</text>
        </view>
        <view class="record-score">
          <text class="score">{{item.score}}</text>
        </view>
      </view>

      <view class="empty-state" wx:if="{{testRecords.length === 0}}">
        <text class="empty-text">æš‚æ— æµ‹è¯•è®°å½•</text>
      </view>
    </view>
    </block>
  </view>
</scroll-view>

