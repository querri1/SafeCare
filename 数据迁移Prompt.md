# 安心宝小程序 - 数据迁移 Prompt

## 项目概述

这是一个名为"安心宝"的心理健康管理微信小程序项目，基于微信云开发构建。项目已完成核心功能开发，现在需要进行数据迁移或功能扩展。

## 项目基本信息

- **小程序 AppID**: `wx88551838ba39bd6c`
- **云开发环境ID**: `cloud1-4ghau10w942b2505`
- **项目路径**: `E:\SafeCare\`
- **小程序源码路径**: `miniprogram/`
- **云函数路径**: `cloudfunctions/`

## 已实现的核心功能

### 1. 页面结构
- **治愈中心** (`pages/healing-center/`): 主要功能入口页面
  - 心理健康自测：一周两次限制，点击时显示PHQ-9、GAD-7、SAS三选一
  - 今日治愈列表：每天轮换显示两个心理测试（PHQ-9、GAD-7、SAS中选两个）
  - 情绪日记：在今日治愈列表最下方，每天都有，不参与随机轮换
- **数据中心** (`pages/data-center/`): 数据统计和图表展示
  - 连续打卡天数统计
  - 最近七天打卡记录（周视图，已打卡天数有明显标识）
    - 柱状图高度代表情绪激动程度（等级1: 33%, 等级2: 66%, 等级3: 100%）
    - 柱状图顶部显示情绪emoji
  - 月视图打卡日历
  - 测试记录查看（支持查看全部，支持时间筛选：近7天/近30天/全部）
- **个人中心** (`pages/profile/`): 用户信息管理和设置
  - 显示连续打卡和总完成次数
  - 退出登录时重置所有数据
  - **用户头像和昵称编辑**：登录时自动获取微信头像和昵称，支持用户自定义修改
  - 头像编辑：点击头像可更换（从相册选择或拍照），上传到云存储
  - 昵称编辑：点击昵称旁边的编辑图标可修改昵称
  - **年龄编辑**：显示和编辑用户年龄（1-120岁）
- **五音疗法** (`pages/music-therapy/`): 角音音频播放器
  - 支持真机播放（已优化iOS兼容性）
  - 支持选择歌曲播放（播放列表显示）
  - 疗愈完成后提示用户记录心情
  - 五音图标：角、宫、商、羽使用PNG图标，背景色与图标颜色一致（宫音金黄色、商音白色、羽音黑色）
- **健身操练习** (`pages/baduanjin/`): 视频播放页面
  - 支持五种类型：趣味健身操、标准八段锦、自在肩颈操、本草纲目、暴汗燃脂操
  - 点击"开始练习"时显示选择弹窗（五选一）
  - 通过URL参数区分视频类型：`type=fun`（趣味健身操）、`type=standard`（标准八段锦）、`type=shoulder`（自在肩颈操）、`type=herbal`（本草纲目）、`type=sweat`（暴汗燃脂操）
  - 视频播放完成后提示用户记录心情
  - 包含计时器功能，记录练习时长
  - 显示练习说明、注意事项和关键要点
  - 每种健身操都有对应的练习说明和描述
- **PHQ-9 抑郁筛查** (`pages/phq9/`): 9题抑郁自评量表
  - 单题模式，每题占满一屏
  - 使用温和的提示语，避免病理化语言
- **GAD-7 焦虑筛查** (`pages/gad7/`): 7题焦虑自评量表
  - 单题模式，每题占满一屏
  - 使用温和的提示语，避免病理化语言
- **SAS 焦虑自评量表** (`pages/sas/`): 20题焦虑自评量表
  - 单题模式，每题占满一屏
  - 支持反向计分（5、9、13、17、19题）
  - 标准分 = 总粗分 × 1.25（取整数）
  - 使用温和的提示语，避免病理化语言
- **我的数据** (`pages/my-data/`): 详细数据统计页面
- **打卡日历** (`pages/checkin-calendar/`): 日历视图显示打卡记录
  - 点击已打卡的日期可以查看当日的情绪记录和日记
  - 显示该日期的所有情绪记录（健身操、五音疗法）
  - 显示该日期的日记内容
  - 可以直接跳转到情绪日记页面编辑
- **日期详情** (`pages/day-detail/`): 独立的日期详情页面
  - 显示该日期的所有情绪记录（带emoji和活动类型）
  - 显示最近一次情绪对应的调养指南（基于《五情对五脏.md》）
  - 只要有情绪记录就显示调养指南，不依赖日记
  - 显示日记内容（如果有）
  - 支持编辑/写日记功能
  - 空状态提示（有打卡但无记录时，用温和的语气提醒）
- **评分评估** (`pages/score-assessment/`): 独立的评分评估页面（新增）
  - 支持单独评分"每日核心追踪"或"自我深度探索"
  - 显示每日提醒词引导用户打分
  - 完成评分后自动保存到数据库
  - 平均分 ≤ 4 时显示关怀性追问
  - 关怀性追问后可以跳转到情绪日记页面写心里话（此时日记还未保存）
- **提醒设置** (`pages/reminders/`): 设置健身操、五音疗法、测试提醒
- **隐私设置** (`pages/privacy/`): 数据同步、分析、分享设置
- **帮助与反馈** (`pages/help/`): 常见问题和反馈入口（邮箱：safe_care_support@163.com）
- **成就徽章** (`pages/achievements/`): 参考Keep的打卡成就系统

### 2. 云开发配置

#### 云函数
- **login** (`cloudfunctions/login/`): 获取用户 openid
  - 文件：`index.js`, `package.json`
  - 功能：返回 `{openid, appid, unionid}`

#### 云数据库集合
- **users**: 存储用户信息（头像、昵称、openid、年龄等）
  - 字段：`_openid`, `nickName`, `avatarUrl`, `age`, `gender`, `country`, `province`, `city`, `createdAt`, `updatedAt`
- **screening_records**: 存储心理测试记录（PHQ-9、GAD-7、SAS）
  - 字段：`type` (PHQ-9/GAD-7/SAS), `answers` (数组), `score` (总分), `rawScore` (仅SAS有，原始粗分), `severity` (严重程度), `createdAt`
- **checkin_records**: 存储用户打卡记录
  - 字段：`date` (Date类型，打卡日期), `activities` (Array类型，活动类型数组), `createdAt`, `updatedAt`
  - 活动类型：`'baduanjin'` (健身操，包括趣味健身操和标准八段锦), `'music'` (五音疗法), `'phq9'` (PHQ-9测试), `'gad7'` (GAD-7测试), `'sas'` (SAS测试)
- **emotion_records**: 存储情绪记录
  - 字段：`activityType` ('baduanjin' | 'music'), `emotion` ('happy' | 'angry' | 'sad' | 'worry' | 'fear'), `level` (1-轻微, 2-中等, 3-强烈), `date` (Date类型), `createdAt`
- **emotion_diary**: 存储情绪日记和评分
  - 字段：`content` (日记内容，最多1000字), `scores` (Object类型，评分数据), `coreTotal` (Number类型，每日核心追踪总分), `deepTotal` (Number类型，自我深度探索总分), `date` (Date类型), `createdAt`, `updatedAt`
  - **评分数据结构**：`scores` 对象包含14个维度的评分（6个每日核心追踪 + 8个自我深度探索）
    - 每日核心追踪：`emotionStability`, `pressurePerception`, `bodyRelaxation`, `sleepRecovery`, `positiveEnergy`, `healthControl`
    - 自我深度探索：`dietNourishment`, `exerciseComfort`, `screenDetachment`, `anxietyRumination`, `selfCompassion`, `bodyAttention`, `communicationSmoothness`, `relationshipSupport`
  - **重要**：评分和日记内容分开保存，评分可以独立保存，不依赖日记内容

#### 云存储结构
- **video/baduanjin-9f2582a4.mp4**: 标准八段锦练习视频
- **video/fun-exercise.mp4**: 趣味健身操视频
- **video/shoulder-exercise.mp4**: 自在肩颈操视频（需要上传）
- **video/herbal-exercise.mp4**: 本草纲目视频（需要上传）
- **video/sweat-exercise.mp4**: 暴汗燃脂操视频（需要上传）
- **audio/jue/**: 角音音乐文件（12首mp3）
  - jue-01-jiangnan-sizhu.mp3
  - jue-02-caomu-qingqing.mp3
  - jue-03-liezi-yufeng.mp3
  - jue-04-jiangnan-hao.mp3
  - jue-05-gusuxing-orc.mp3
  - jue-06-hujia-shibapai.mp3
  - jue-07-liangzhu.mp3
  - jue-08-chunfeng-deyi.mp3
  - jue-09-mumin-xinge.mp3.mp3
  - jue-10-zhuangzhou-mengdie.mp3
  - jue-11-gusuxing-yuxunfa.mp3
  - jue-12-zhegufei.mp3

### 3. 关键代码逻辑

#### 登录流程（`pages/profile/profile.js`）
```javascript
// 登录流程：用户点击按钮 → wx.getUserProfile（必须在点击事件中直接调用）
// → 获取用户信息 → 调用云函数获取openid → 保存到数据库
```

#### 云存储访问（`utils/cloudStorage.js`）
- `getCloudFileURL(cloudPath)`: 获取单个文件的临时URL
- `getCloudFileURLs(cloudPaths)`: 批量获取文件的临时URL
- 使用 `wx.cloud.getTempFileURL` API
- **重要**：安卓端必须使用临时URL，不能直接使用云存储File ID
- **权限要求**：云存储文件权限必须设置为"所有用户可读"或"所有用户可读，仅创建者可写"
- **错误处理**：识别 `STORAGE_EXCEED_AUTHORITY` 权限错误，提供详细的错误提示

#### 五音疗法播放逻辑（`pages/music-therapy/music-therapy.js`）
- **五音顺序**：角、徵、宫、商、羽（角音放在第一位）
- 支持角音播放（其他四音提示"功能未开放"）
- 随机选择起始曲目，然后循环播放
- 显示播放进度和时间
- **进度条可拖动调整**：支持拖动进度条跳转到指定位置
- 播放列表从云存储加载

#### 心理健康筛查（`pages/phq9/`, `pages/gad7/`, `pages/sas/`）
- **PHQ-9**: 9题，每题0-3分，总分0-27分
  - 单题模式，每题占满一屏
  - 使用温和的提示语："过去两周你的状态如何？"
- **GAD-7**: 7题，每题0-3分，总分0-21分
  - 单题模式，每题占满一屏
  - 使用温和的提示语："过去两周你的状态如何？"
- **SAS**: 20题，每题1-4分，标准分0-100分
  - 单题模式，每题占满一屏
  - 支持反向计分（5、9、13、17、19题）
  - 标准分 = 总粗分 × 1.25（取整数）
  - 使用温和的提示语："过去两周你的状态如何？"
- 评分标准已实现，结果保存到云数据库
- **一周两次限制**：系统限制每周最多测试2次，但可以继续测试（会提示用户）
- **选择机制**：点击"开始测试"时显示选择弹窗（PHQ-9、GAD-7、SAS三选一）
- **今日轮换**：每天在"今日治愈"列表中轮换显示两个测试（PHQ-9、GAD-7、SAS中选两个）

#### 打卡系统（`utils/checkin.js`）
- **打卡规则**：只要完成了今日治愈的任意一个项目就算成功打卡
  - 健身操练习完成（任意一种类型：趣味健身操、标准八段锦、自在肩颈操、本草纲目、暴汗燃脂操）
  - 五音疗法完成
  - PHQ-9、GAD-7或SAS测试完成
- **打卡记录**：保存到 `checkin_records` 集合
- **自动去重**：同一天多次完成不同活动，只算一次打卡（但会记录所有活动类型）
- **情绪记录**：完成健身操或五音疗法后，提示用户记录心情
  - 情绪记录保存到 `emotion_records` 集合
  - 支持中医五情：喜、怒、悲、忧、恐
  - 每个情绪有3个等级（轻微、中等、强烈）

#### 数据中心功能（`pages/data-center/`）
- **连续打卡天数**：从今天往前计算连续打卡天数
- **本周完成次数**：统计本周（周一到周日）的打卡次数
- **本月成就**：统计本月的打卡天数
- **最近七天打卡记录**（周视图）：
  - 柱状图显示，已打卡天数有明显的绿色对勾图标标识
  - 已打卡的柱子更粗、有阴影和边框
  - 标签文字高亮显示
  - **情绪可视化**：如果记录了情绪，柱状图高度代表情绪激动程度
    - 等级1（轻微）：87rpx（33%）
    - 等级2（中等）：173rpx（66%）
    - 等级3（强烈）：280rpx（100%）
    - 使用固定rpx单位，确保正确显示
  - 柱状图顶部显示情绪emoji（不遮挡"周/月"切换按钮）
  - 点击月视图中的日期可以跳转到日期详情页面
- **月视图**：显示当前月的打卡日历，已打卡日期高亮显示
- **评分趋势柱状图**（新增）：
  - 显示两个独立的柱状图：每日核心追踪和自我深度探索
  - 显示最近7天的评分数据，每个柱子代表一天的分数
  - 柱状图设计参考打卡记录柱状图，使用相同的样式和布局
  - 每个柱子显示分数值，高度按比例计算
  - 柱子下方显示日期标签（周几）
- **测试记录查看**：显示最近的5条测试记录，支持查看全部
  - 测试记录页面（`pages/test-records/`）：单独页面显示，按日期分组
  - 支持时间筛选：近7天、近30天、全部
  - 显示测试类型、分数、严重程度、测试时间
  - 支持时间筛选：近7天、近30天、全部
  - 测试记录页面：单独页面显示，按日期分组

#### 治愈中心功能（`pages/healing-center/`）
- **动态完成状态**：根据今日打卡记录动态显示健身操和五音疗法的完成状态
- **实时刷新**：从其他页面返回时自动刷新完成状态
- **健身操选择**：点击"开始练习"时显示选择弹窗（五选一：趣味健身操、标准八段锦、自在肩颈操、本草纲目、暴汗燃脂操）
- **今日治愈列表**：
  - 健身操练习（每天都有）
  - 五音疗法（每天都有）
  - 两个心理测试（每天轮换：PHQ-9、GAD-7、SAS中选两个）
  - 情绪日记（每天都有，不参与随机轮换）

#### 登录状态管理（`utils/auth.js`）
- **登录状态检查**：`isLoggedIn()`, `getOpenid()`
- **数据清除**：`clearUserData()` - 退出登录时清除所有本地缓存
- **状态设置**：`setLoginState()` - 登录时设置状态
- **数据重置**：退出登录后，所有页面数据自动重置，重新登录后显示该用户的数据

#### 个人中心功能页面
- **我的数据** (`pages/my-data/`):
  - 总体统计：总打卡次数、连续打卡天数、总测试次数
  - 活动统计：健身操和五音疗法的完成次数
  - 本周/本月统计
- **打卡日历** (`pages/checkin-calendar/`):
  - 日历视图显示打卡情况
  - 支持月份切换
  - 已打卡日期高亮显示
- **提醒设置** (`pages/reminders/`):
  - 健身操练习提醒（可设置时间）
  - 五音疗法提醒（可设置时间）
  - 心理健康测试提醒（可设置时间）
  - 设置保存到本地存储
- **隐私设置** (`pages/privacy/`):
  - 数据同步开关
  - 数据分析开关
  - 数据分享开关
  - 清除所有数据功能
- **帮助与反馈** (`pages/help/`):
  - 常见问题（可展开/收起）
  - 提交反馈（邮箱：safe_care_support@163.com）
  - 版本信息
- **成就徽章** (`pages/achievements/`): 参考Keep的打卡成就系统
  - **连续打卡成就**：初出茅庐(3天)、坚持不懈(7天)、持之以恒(14天)、月度坚持(30天)、百日坚持(100天)
  - **总打卡成就**：入门新手(10次)、活跃用户(30次)、打卡达人(100次)
  - **活动成就**：健身操新手/达人(10/50次)、音乐疗愈者/大师(10/50次)
  - **测试成就**：自我了解(5次)、心理健康专家(20次)
  - 已解锁成就：彩色显示，带进度条和完成标记
  - 未解锁成就：灰色显示，显示当前进度

#### 音频播放优化（`pages/music-therapy/`）
- **iOS真机兼容性**：
  - 设置 `obeyMuteSwitch = false` 允许静音模式播放
  - 设置 `volume = 1.0` 最大音量
  - 添加音频上下文自动恢复机制
- **加载提示优化**：
  - 修复 showLoading 和 hideLoading 配对问题
  - 添加超时机制（10秒）
  - 在 onPlay 事件中隐藏加载提示
- **错误处理**：
  - 检测到 "audioInstance is not set" 错误时自动重新创建音频上下文
  - 添加详细的调试日志

## 重要配置信息

### project.config.json
```json
{
  "miniprogramRoot": "miniprogram/",
  "cloudfunctionRoot": "cloudfunctions/",
  "packOptions": {
    "ignore": [
      {"type": "folder", "value": "miniprogram/node_modules"},
      {"type": "folder", "value": "miniprogram/miniprogram_npm"},
      {"type": "folder", "value": "node_modules"}
    ]
  }
}
```

### app.json 页面配置
```json
{
  "pages": [
    "pages/healing-center/healing-center",
    "pages/data-center/data-center",
    "pages/profile/profile",
    "pages/music-therapy/music-therapy",
    "pages/baduanjin/baduanjin",
    "pages/phq9/phq9",
    "pages/gad7/gad7",
    "pages/sas/sas",
    "pages/sas-result/sas-result",
    "pages/my-data/my-data",
    "pages/checkin-calendar/checkin-calendar",
    "pages/reminders/reminders",
    "pages/privacy/privacy",
    "pages/help/help",
    "pages/achievements/achievements",
    "pages/test-records/test-records",
    "pages/emotion-selector/emotion-selector",
    "pages/emotion-diary/emotion-diary",
    "pages/day-detail/day-detail",
    "pages/score-assessment/score-assessment"
  ]
}
```

### app.js 云开发初始化
```javascript
wx.cloud.init({
  env: 'cloud1-4ghau10w942b2505',
  traceUser: true
})
```

## 数据迁移注意事项

### 1. 云开发环境
- 确保目标环境已创建并配置
- 环境ID需要更新到新环境
- 云函数需要重新部署

### 2. 云数据库
- **users 集合**: 用户数据，包含 `_openid`, `nickName`, `avatarUrl`, `age`, `gender`, `country`, `province`, `city`, `createdAt`, `updatedAt`
- **screening_records 集合**: 测试记录，包含 `type` (PHQ-9/GAD-7/SAS), `answers`, `score`, `rawScore` (仅SAS), `severity`, `createdAt`, `_openid`
- **emotion_records 集合**: 情绪记录，包含 `activityType`, `emotion`, `level`, `date`, `createdAt`, `_openid`
- **emotion_diary 集合**: 情绪日记和评分，包含 `content` (日记内容), `scores` (Object类型，评分数据), `coreTotal` (Number类型，每日核心追踪总分), `deepTotal` (Number类型，自我深度探索总分), `date`, `createdAt`, `updatedAt`, `_openid`

### 3. 云存储
- 视频文件：
  - `video/baduanjin-9f2582a4.mp4`（标准八段锦）
  - `video/fun-exercise.mp4`（趣味健身操）
  - `video/shoulder-exercise.mp4`（自在肩颈操）
  - `video/herbal-exercise.mp4`（本草纲目）
  - `video/sweat-exercise.mp4`（暴汗燃脂操）
- 音频文件：`audio/jue/*.mp3` (12个文件)
- 需要重新上传到新环境，并更新代码中的 File ID

### 4. 代码中需要更新的路径
- `miniprogram/pages/baduanjin/baduanjin.js`: 视频云存储路径
  - 标准八段锦：`video/baduanjin-9f2582a4.mp4`
  - 趣味健身操：`video/fun-exercise.mp4`
  - 自在肩颈操：`video/shoulder-exercise.mp4`（需要上传）
  - 本草纲目：`video/herbal-exercise.mp4`（需要上传）
  - 暴汗燃脂操：`video/sweat-exercise.mp4`（需要上传）
- `miniprogram/pages/music-therapy/music-therapy.js`: 音频云存储路径列表
- `miniprogram/app.js`: 云开发环境ID

### 6. 情绪日记和评分相关文件
- `miniprogram/utils/emotion.js`: 情绪工具函数
- `miniprogram/utils/emotionGuide.js`: 情绪调养指南工具函数（基于《五情对五脏.md》）
- `miniprogram/utils/diaryScores.js`: 情绪日记评分工具函数（新增）
  - 定义评分维度和提示语
  - 提供评分计算和低分检查功能
- `miniprogram/pages/emotion-selector/`: 情绪选择页面
- `miniprogram/pages/emotion-diary/`: 情绪日记页面（显示评分入口和文字日记）
- `miniprogram/pages/score-assessment/`: 评分评估页面（新增，独立评分功能）
- `miniprogram/pages/day-detail/`: 日期详情页面（显示情绪记录、调养指南和日记）
- `miniprogram/pages/baduanjin/baduanjin.js`: 视频完成后提示记录心情，记录心情后提示写日记
- `miniprogram/pages/music-therapy/music-therapy.js`: 疗愈完成后提示记录心情，记录心情后提示写日记
- `miniprogram/pages/data-center/data-center.js`: 情绪柱状图显示，点击日期跳转到详情页面，固定提示文案
- `miniprogram/pages/checkin-calendar/checkin-calendar.js`: 点击日期跳转到详情页面

### 5. 新增工具函数
- `miniprogram/utils/checkin.js`: 打卡工具函数
  - `recordCheckin(activityType)`: 记录打卡
  - **重复键错误处理**：自动处理E11000重复键错误，避免并发插入冲突
- `miniprogram/utils/auth.js`: 登录状态管理工具函数
  - `isLoggedIn()`: 检查是否已登录
  - `getOpenid()`: 获取当前用户openid
  - `clearUserData()`: 清除所有用户数据
  - `setLoginState(openid, userInfo)`: 设置登录状态
  - `initLoginState()`: 从本地缓存恢复登录状态
- `miniprogram/utils/emotion.js`: 情绪工具函数
  - `EMOTION_TYPES`: 情绪类型常量（happy, angry, sad, worry, fear）
  - `EMOTION_LEVELS`: 情绪等级常量（1-轻微, 2-中等, 3-强烈）
  - `EMOTION_CONFIG`: 情绪配置（emoji和文字）
  - `saveEmotionRecord(activityType, emotion, level)`: 保存情绪记录
  - `getEmotionDisplay(emotion, level)`: 获取情绪显示文本（emoji+文字）
  - `getEmotionName(emotion)`: 获取情绪名称
- `miniprogram/utils/emotionGuide.js`: 情绪调养指南工具函数（新增）
  - `EMOTION_GUIDE`: 情绪调养指南配置（基于《五情对五脏.md》）
  - `EMOTION_TIP`: 温馨提示文本
  - `getEmotionGuide(emotion)`: 获取情绪调养指南
- `miniprogram/utils/diaryScores.js`: 情绪日记评分工具函数（新增）
  - `CORE_TRACKING`: 每日核心追踪维度（6个维度）
  - `DEEP_EXPLORATION`: 自我深度探索维度（8个维度）
  - `getDailyReminder()`: 获取每日提醒词（随机）
  - `calculateTotalScore(scores, dimensions)`: 计算板块总分
  - `checkLowScore(scores)`: 检查是否有低分板块（≤4分）
  - `checkSingleBlockLowScore(scores, dimensions)`: 检查单个板块是否有低分
  - `getLowScorePrompt(block)`: 获取低分关怀提示语

## 已解决的问题

1. ✅ 图标替换：从设计图提取图标，替换到小程序中
2. ✅ 五音疗法：实现角音音频播放，随机起始+循环播放
3. ✅ 八段锦视频：云存储视频播放
4. ✅ PHQ-9/GAD-7：完整的心理健康筛查功能
5. ✅ 微信登录：基于云开发的用户登录注册
6. ✅ 云存储迁移：视频和音频文件迁移到云存储
7. ✅ 登录流程修复：`wx.getUserProfile` 必须在点击事件中直接调用
8. ✅ 心理健康自测限制：改为一周两次，点击测试时显示PHQ-9和GAD-7二选一
9. ✅ 打卡系统：实现完整的打卡记录功能（checkin_records集合）
10. ✅ 数据中心完善：连续打卡、最近七天打卡记录、月视图、测试记录查看
11. ✅ 登录状态管理：退出登录时重置数据，登录时重新加载用户数据
12. ✅ 个人中心功能：我的数据、打卡日历、提醒设置、隐私设置、帮助反馈、成就徽章
13. ✅ 音频播放优化：修复iOS真机无声音和加载提示配对问题
14. ✅ 用户头像和昵称编辑：登录时自动获取微信头像和昵称，支持用户自定义修改
15. ✅ 治愈中心完成状态：修复完成状态显示问题，根据打卡记录动态显示
16. ✅ 小程序图标设计：设计温暖富有生命力的黄绿渐变图标
17. ✅ 整体配色优化：将紫色主题改为绿色主题，更符合心理健康主题
18. ✅ 健身操功能升级：将八段锦改为健身操，支持趣味健身操和标准八段锦两种类型
19. ✅ 安卓端兼容性优化：修复云存储权限错误和音频播放问题，改进错误处理
20. ✅ SAS量表实现：新增SAS焦虑自评量表，支持反向计分和标准分计算
21. ✅ 心理测试优化：PHQ-9和GAD-7改为单题模式，每题占满一屏，使用温和提示语
22. ✅ 今日治愈轮换：每天轮换显示两个心理测试（PHQ-9、GAD-7、SAS中选两个）
23. ✅ 情绪日记功能：完成健身操或五音疗法后可以记录心情，支持写日记
24. ✅ 情绪可视化：在数据中心最近七天打卡记录中显示情绪柱状图
25. ✅ 打卡日历详情：点击已打卡日期可以查看当日的情绪和日记
26. ✅ 个人中心年龄：添加年龄显示和编辑功能
27. ✅ 测试记录优化：支持时间筛选（近7天/近30天/全部），单独页面显示
28. ✅ 情绪emoji优化：修改"恐"选项的emoji（选项二和选项三调换：中等😨，强烈😱）
29. ✅ 数据中心柱状图修复：修复柱状图显示问题，使用固定rpx单位，emoji显示在顶部
30. ✅ 打卡日历详情查看：修复点击日期查看情绪和日记的功能，改进日期处理逻辑
31. ✅ 情绪日记界面优化：添加渐变背景、装饰元素、动画效果，界面更生动美观
32. ✅ 日期详情页面：创建独立的日期详情页面（day-detail），显示情绪记录和日记
33. ✅ 情绪调养指南：基于《五情对五脏.md》添加情绪解释和调养方法，显示在日期详情页面
34. ✅ 打卡记录重复键错误修复：添加重复键错误处理，解决并发插入导致的E11000错误
35. ✅ 保存日记成功提示：保存日记后提示用户在哪里查看日记和情绪记录，支持快速跳转
36. ✅ 真机调试错误说明：更新文档，添加安卓端调试连接错误的说明和解决方案
37. ✅ 情绪调养指南显示优化：修复安卓端需要先保存日记才能看到情绪解释和调养方法的问题，现在只要有情绪记录就能显示
38. ✅ 真机调试页面空白修复：移除skyline渲染器配置，添加错误处理，解决安卓端真机调试页面空白问题
39. ✅ 情绪日记提示语优化：在治愈中心页面，情绪日记卡片下方每天随机显示不同的温馨提示语（8条轮换）
40. ✅ 记录心情后日记提醒：完成健身操或五音疗法并记录心情后，用温和的话语提醒用户是否要记录日记
41. ✅ 情绪日记评分表功能：添加自我评分表（每日核心追踪6个维度 + 自我深度探索8个维度），评分表在前，文字日记在后
42. ✅ 五音疗法顺序调整：将五音疗法顺序改为角、徵、宫、商、羽（角音放在第一位）
43. ✅ 音乐播放器进度条：添加可拖动调整的进度条功能
44. ✅ 数据中心固定提示文案：添加固定提示："这些评分是您自我觉察的宝贵工具，但不能替代医生的专业诊断哦。定期复查并与您的主治医生沟通至关重要。"
45. ✅ 评分与日记分离：创建独立的评分页面（score-assessment），将评分和日记功能完全分离，解决低分关怀性追问逻辑冲突问题
46. ✅ 数据中心评分趋势柱状图：实现两个评分板块（每日核心追踪和自我深度探索）的周变化柱状图，参考打卡记录柱状图设计，显示最近7天的评分数据
47. ✅ 五音疗法图标优化：将角、宫、商、羽四个音的图标从emoji替换为PNG图片，并优化背景色（宫音金黄色、商音白色、羽音黑色）
48. ✅ 健身操功能扩展：新增三个健身操类型（自在肩颈操、本草纲目、暴汗燃脂操），选择弹窗从2个选项扩展为5个选项

## 技术栈

- 微信小程序原生开发
- 微信云开发（数据库、存储、云函数）
- JavaScript
- WXSS
- 自定义组件（navigation-bar）

## 设计参考

- 设计图路径：`e:\safe_care_desigh/`
- **主色调**：`#34D399`（柔和绿色，emerald-300）
- **辅助色**：`#A3E635`（黄绿色，lime-400）
- **渐变配色**：`linear-gradient(135deg, #A3E635, #34D399)`（黄绿渐变）
- **设计风格**：现代化卡片式设计，渐变色和圆角元素，温暖富有生命力
- **小程序图标**：`miniprogram/images/app-icon.svg`
  - 设计元素：四片叶子围绕中心圆形，代表生命力和成长
  - 配色：黄绿渐变（#FDE047 → #A3E635 → #34D399）
  - 风格：温暖、富有生命力

## 下一步可能的工作

1. 数据迁移到新环境
2. 功能扩展（其他四音疗法、更多测试量表等）
3. ~~数据统计和分析功能完善~~ ⚠️ 部分完成（待完成：数据中心折线图）
4. ~~用户打卡系统实现~~ ✅ 已完成
5. ~~成就徽章系统~~ ✅ 已完成
6. ~~音频播放问题进一步优化（iOS真机无声音问题）~~ ✅ 已优化
7. 提醒功能的实际推送实现
8. 数据导出功能
9. ~~情绪调养指南功能~~ ✅ 已完成
10. ~~日期详情页面~~ ✅ 已完成
11. ~~打卡记录重复键错误修复~~ ✅ 已完成
12. **数据中心折线图**：添加两个评分板块（每日核心追踪和自我深度探索）的周变化和月变化折线图（不与柱状图重叠，新建在另一块区域）

## 重要注意事项

### 音频播放问题
- iOS真机可能存在无声音问题，已设置 `obeyMuteSwitch = false` 和 `volume = 1.0`
- 如果真机无声音，请检查：设备音量、静音开关、音频格式、网络连接
- 音频加载提示已优化，避免 showLoading 和 hideLoading 不配对的问题
- **安卓端兼容性**：
  - 安卓端必须使用临时URL播放音频，不能直接使用云存储File ID
  - 如果出现 `STORAGE_EXCEED_AUTHORITY` 错误，需要检查云存储文件权限
  - 建议将音频和视频文件权限设置为"所有用户可读"
  - 错误处理已优化，自动识别权限错误并提供解决方案提示

### 打卡系统
- 打卡记录保存在 `checkin_records` 集合中
- **重要**：`checkin_records` 集合在 `date` 字段上有唯一索引（`date_1`），避免重复记录
- 同一天多次完成不同活动，只算一次打卡（但会记录所有活动类型到 `activities` 数组）
- **重复键错误处理**：
  - 代码已优化，自动处理E11000重复键错误（并发插入冲突）
  - 当插入时遇到重复键错误，会自动重新查询并更新现有记录
  - 避免因并发请求导致的数据库错误
- 打卡触发点：
  - 健身操：视频播放完成时（`onVideoEnded`，包括趣味健身操和标准八段锦）
  - 五音疗法：角音播放完成时（`recordTherapyCompletion`）
  - PHQ-9/GAD-7/SAS：测试提交成功时（`onSubmit`）

### 登录状态管理
- 退出登录时会清除所有本地缓存数据
- 重新登录后会自动加载该用户的数据
- 所有数据查询都通过 `_openid` 自动关联用户

### 心理健康测试限制
- 每周最多测试2次（从周一开始计算）
- 点击"开始测试"时会检查是否已达到限制
- 达到限制后仍可继续测试（会提示用户是否继续）
- 未达到限制时显示选择弹窗（PHQ-9、GAD-7、SAS三选一）
- **今日轮换机制**：每天在"今日治愈"列表中轮换显示两个测试
  - 根据一年中的第几天（dayOfYear）计算
  - 确保每天显示两个不同的测试

### 云存储权限配置
- **重要**：安卓端必须使用临时URL访问云存储文件，不能直接使用File ID
- **权限要求**：音频和视频文件权限必须设置为"所有用户可读"或"所有用户可读，仅创建者可写"
- **常见错误**：`STORAGE_EXCEED_AUTHORITY` 表示权限不足，需要在云开发控制台修改文件权限
- **配置指南**：详见 `云存储权限配置指南.md`
- **错误处理**：代码已优化，会自动识别权限错误并提供详细的解决方案提示

### 真机调试常见问题
- **调试连接错误**（安卓端常见）：
  - 错误信息：`连接断开`、`服务器忙`、`cmdld 1006, errCode -1`
  - 原因：微信开发者工具与真机之间的调试连接问题，不是代码问题
  - 影响：可能影响调试功能，但不影响小程序实际运行
  - 解决方案：检查网络连接、重启调试、使用预览模式、或忽略错误
- **框架内部错误**：
  - `not node js file system`、`wxfile://` 路径错误等
  - 这些是框架内部错误，不影响程序运行，可以忽略
- **详细说明**：详见 `真机调试常见错误说明.md`

### 用户信息管理
- **登录时**：自动获取微信头像和昵称，保存到云数据库
- **再次登录**：保留用户自定义的头像、昵称和年龄，不覆盖
- **头像编辑**：
  - 点击头像右下角编辑图标可更换头像
  - 支持从相册选择或拍照
  - 上传到云存储 `avatars/` 目录
  - 自动更新数据库和页面显示
- **昵称编辑**：
  - 点击昵称旁边的编辑图标可修改昵称
  - 最多20个字符
  - 自动更新数据库和页面显示
- **年龄编辑**：
  - 点击年龄旁边的编辑图标可修改年龄
  - 范围：1-120岁
  - 自动更新数据库和页面显示

### 健身操功能
- **五种类型**：趣味健身操、标准八段锦、自在肩颈操、本草纲目、暴汗燃脂操
- **选择方式**：点击"开始练习"时显示选择弹窗（五选一）
- **视频路径**：
  - 标准八段锦：`video/baduanjin-9f2582a4.mp4`
  - 趣味健身操：`video/fun-exercise.mp4`
  - 自在肩颈操：`video/shoulder-exercise.mp4`（需要上传）
  - 本草纲目：`video/herbal-exercise.mp4`（需要上传）
  - 暴汗燃脂操：`video/sweat-exercise.mp4`（需要上传）
- **打卡记录**：所有类型都记录为 `'baduanjin'` 活动类型
- **完成提示**：视频播放完成后显示激励性提示，然后提示记录心情
- **计时器**：记录练习时长，显示在页面上
- **页面内容**：包含练习说明、注意事项和关键要点
  - 每种健身操都有对应的练习说明和描述
  - 标准八段锦额外显示动作要点

### 情绪日记功能
- **情绪记录**：
  - 完成健身操或五音疗法后，提示用户记录心情
  - 支持中医五情：喜、怒、悲、忧、恐
  - 每个情绪有3个等级：轻微、中等、强烈
  - 情绪emoji配置：
    - 喜：😊（轻微）、😄（中等）、😆（强烈）
    - 怒：😐（轻微）、😠（中等）、😡（强烈）
    - 悲：😔（轻微）、😢（中等）、😭（强烈）
    - 忧：😮‍💨（轻微）、😓（中等）、😰（强烈）
    - 恐：😰（轻微）、😨（中等）、😱（强烈）
  - **记录心情后日记提醒**：记录心情成功后，用温和的话语提醒用户是否要记录日记
- **情绪日记**：
  - 在治愈中心"今日治愈"列表最下方，每天都有
  - 情绪日记卡片下方每天随机显示不同的温馨提示语（8条轮换）
  - 显示两个评分入口卡片（每日核心追踪、自我深度探索），点击进入独立评分页面
  - 情绪日记卡片下方每天随机显示不同的温馨提示语（8条轮换）
  - 显示两个评分入口卡片（每日核心追踪、自我深度探索），点击进入独立评分页面
  - 用户可以写日记记录每天的心情和想法
  - 支持最多1000字
  - 每天可以编辑和保存日记
  - 保存成功后提示用户在哪里查看日记和情绪记录，支持快速跳转到数据中心
- **自我评分表**（独立页面）：
  - **每日核心追踪**（6个维度）：情绪平稳度、压力感知值、身体放松感、睡眠修复力、正向能量值、健康掌控感
  - **自我深度探索**（8个维度）：饮食滋养度、运动舒畅感、屏幕游离度、焦虑反刍度、自我关怀度、身体关注度、沟通顺畅度、关系支持感
  - 每个维度0-5分评分
  - 评分完成后自动保存
  - 平均分 ≤ 4 时显示关怀性追问，可以跳转到情绪日记页面写心里话
  - 评分和日记完全分离，互不干扰
- **自我评分表**（独立页面）：
  - **每日核心追踪**（6个维度）：情绪平稳度、压力感知值、身体放松感、睡眠修复力、正向能量值、健康掌控感
  - **自我深度探索**（8个维度）：饮食滋养度、运动舒畅感、屏幕游离度、焦虑反刍度、自我关怀度、身体关注度、沟通顺畅度、关系支持感
  - 每个维度0-5分评分
  - 评分完成后自动保存
  - 平均分 ≤ 4 时显示关怀性追问，可以跳转到情绪日记页面写心里话
  - 评分和日记完全分离，互不干扰
- **情绪可视化**：
  - 在数据中心最近七天打卡记录中，柱状图高度代表情绪激动程度
  - 等级1：33%高度，等级2：66%高度，等级3：100%高度
  - 柱状图顶部显示情绪emoji
- **打卡日历详情**：
  - 点击已打卡的日期可以查看当日的情绪记录和日记
  - 显示该日期的所有情绪记录（健身操、五音疗法）
  - 显示该日期的日记内容
  - 可以直接跳转到情绪日记页面编辑
- **日期详情页面**：
  - 独立的日期详情页面（`pages/day-detail/`）
  - 显示该日期的所有情绪记录（带emoji和活动类型）
  - 显示最近一次情绪对应的调养指南（情绪解释和3个简单调养方法）
  - 显示日记内容（如果有）
  - 支持编辑/写日记功能
  - 空状态提示（有打卡但无记录时，用温和的语气提醒）
- **情绪调养指南**：
  - 基于《五情对五脏.md》文档
  - 在日期详情页面中，情绪记录和日记之间显示
  - 只要有情绪记录就会显示，不依赖日记
  - 多个情绪时，以最近一次情绪为准
  - 包含情绪解释（中医理论）和3个简单调养方法
  - 显示温馨提示："情绪是信号，不是敌人..."

### 颜色主题
- **主色调**：`#34D399`（柔和绿色）
- **辅助色**：`#A3E635`（黄绿色）
- **渐变**：`linear-gradient(135deg, #A3E635, #34D399)`
- **TabBar选中色**：`#34D399`
- **设计理念**：温暖、富有生命力，符合心理健康主题

### 情绪日记功能
- **数据集合**：
  - `emotion_records`: 存储情绪记录（活动类型、情绪类型、等级、日期）
  - `emotion_diary`: 存储情绪日记和评分（内容、评分数据、总分、日期）
- **情绪类型**：中医五情（喜、怒、悲、忧、恐）
- **情绪等级**：1-轻微、2-中等、3-强烈
- **触发时机**：完成健身操或五音疗法后提示记录心情
- **可视化**：在数据中心最近七天打卡记录中，柱状图高度代表情绪激动程度
- **详情查看**：
  - 在打卡日历中点击已打卡日期，跳转到日期详情页面
  - 在数据中心月视图中点击日期，跳转到日期详情页面
  - 日期详情页面显示情绪记录、调养指南和日记
- **情绪调养指南**：
  - 基于《五情对五脏.md》文档
  - 在日期详情页面中显示（情绪记录和日记之间）
  - 只要有情绪记录就会显示，不依赖日记
  - 多个情绪时，以最近一次情绪为准（按createdAt排序）
  - 包含情绪解释（中医理论，包含古籍引用）和3个简单调养方法
  - 显示温馨提示："情绪是信号，不是敌人..."
- **保存日记成功提示**：
  - 保存日记后显示详细提示，告诉用户在哪里查看日记和情绪记录
  - 提供"去查看"按钮，自动跳转到数据中心并切换到月视图
- **集合创建**：需要在云开发控制台手动创建 `emotion_records` 和 `emotion_diary` 集合
  - 权限建议：仅创建者可读写（保护用户隐私）
  - 详见：`情绪日记集合创建指南.md`

### 数据中心功能增强
- **固定提示文案**：在图表区域和测试记录之间显示固定提示
  - 内容："这些评分是您自我觉察的宝贵工具，但不能替代医生的专业诊断哦。定期复查并与您的主治医生沟通至关重要。"
  - 样式：渐变背景、左侧绿色边框、图标装饰

### 真机调试优化
- **移除skyline渲染器**：解决安卓端真机调试页面空白问题
- **错误处理增强**：在 `app.js` 中添加全局错误处理，过滤框架内部错误
- **页面加载保护**：在关键页面添加 try-catch 错误处理

## 本次对话主要内容（2024年改进）

### 1. 情绪日记评分表功能重构
- **问题**：原设计将评分表和日记放在同一页面，导致低分关怀性追问逻辑冲突
- **解决方案**：创建独立的评分评估页面（`pages/score-assessment/`）
- **实现内容**：
  - 情绪日记页面改为显示两个评分入口卡片
  - 点击卡片进入独立的评分页面
  - 评分完成后自动保存，不依赖日记
  - 平均分 ≤ 4 时显示关怀性追问
  - 关怀性追问后可以跳转到情绪日记页面写心里话（此时日记还未保存）

### 2. 根据《改进方面.md》文档的改进
- ✅ 情绪日记评分表：添加每日核心追踪（6个维度）和自我深度探索（8个维度）
- ✅ 五音疗法顺序调整：改为角、徵、宫、商、羽
- ✅ 音乐播放器进度条：添加可拖动调整功能
- ✅ 数据中心固定提示文案：添加专业诊断提示
- ✅ 数据中心评分趋势柱状图：实现两个评分板块的周变化柱状图（参考打卡记录柱状图设计）

### 3. 数据中心评分趋势功能实现
- **功能描述**：在数据中心页面添加评分趋势柱状图区域，显示两个评分板块的周变化
- **实现内容**：
  - 创建 `loadScoreWeekData()` 方法，从 `emotion_diary` 集合查询最近7天的评分数据
  - 显示两个独立的柱状图：每日核心追踪和自我深度探索
  - 柱状图设计参考打卡记录柱状图，使用相同的样式和布局
  - 每个柱子显示分数值，高度按比例计算（核心追踪最大30分，深度探索最大40分）
  - 柱子下方显示日期标签（周几）
- **数据计算**：
  - 每日核心追踪：最大30分（6个维度×5分）
  - 自我深度探索：最大40分（8个维度×5分）
  - 柱状图高度按比例计算，最大高度280rpx

### 4. 五音疗法图标优化
- **图标替换**：将角、宫、商、羽四个音的图标从emoji替换为PNG图片
  - 角音：`icon-jue.png`
  - 宫音：`icon-gong.png`
  - 商音：`icon-shang.png`
  - 羽音：`icon-yu.png`
- **背景色优化**：根据图标颜色调整背景色
  - 宫音：金黄色（`#FFD700`）
  - 商音：白色（`#FFFFFF`）
  - 羽音：黑色（`#000000`）
  - 角音和徵音保持原有渐变背景

### 5. 健身操功能扩展
- **新增三种健身操**：
  - 自在肩颈操：专门针对肩颈部位设计的舒缓操，适合长时间久坐的人群
  - 本草纲目：结合传统中医理念的健身操，动作流畅自然
  - 暴汗燃脂操：高强度的有氧运动，适合快速燃脂和增强体能
- **实现内容**：
  - 更新治愈中心选择弹窗，从2个选项扩展为5个选项
  - 更新健身操页面，支持新的三种类型（`type=shoulder`、`type=herbal`、`type=sweat`）
  - 为每种健身操添加对应的练习说明和描述
  - 配置对应的视频路径（需要上传视频文件到云存储）
- **视频文件要求**：
  - 自在肩颈操：`video/shoulder-exercise.mp4`
  - 本草纲目：`video/herbal-exercise.mp4`
  - 暴汗燃脂操：`video/sweat-exercise.mp4`

### 6. 其他优化
- ✅ 情绪调养指南显示优化：修复安卓端显示问题
- ✅ 真机调试页面空白修复：移除skyline渲染器
- ✅ 情绪日记提示语优化：每天随机显示温馨提示语
- ✅ 记录心情后日记提醒：添加温和的日记提醒功能

---

**使用说明**：将此 prompt 复制到新的对话中，AI 助手将能够理解项目结构和已完成的功能，帮助进行数据迁移或功能扩展。


